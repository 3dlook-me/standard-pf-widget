/* eslint class-methods-use-this: off */
import { h, Component } from 'preact';
import classNames from 'classnames';
import './UploadFile.scss'

import { getOrientation, fixOrientation } from '../../helpers/utils';

/**
 * Upload file component
 */
export default class UploadFile extends Component {
  constructor(props) {
    super(props);

    this.state = {
      mode: 'placeholder',
      file: null,
      value: null,
    };
  }

  componentDidMount() {
    const { value, change } = this.props;

    if (value) {
      this.setState({
        file: value,
        mode: 'preview',
      }, () => change(value));
    }
  }

  /**
   * Change file input handler
   *
   * @async
   */
  onChange = async (e) => {
    const file = e.target.files[0];
    await this.saveFile(file);
  }

  /**
   * Save file blob to the state
   *
   * @async
   * @param {Blob} file - image file
   */
  async saveFile(file) {
    const { change } = this.props;

    if (!file) {
      return;
    }

    const orientation = await getOrientation(file);
    const fileBase64 = await fixOrientation(file, orientation);

    this.setState({
      file: fileBase64,
      mode: 'preview',
    }, () => change(fileBase64));
  }

  /**
   * Disable dragOver and dragLeave events
   */
  disableDragEvents = (e) => {
    e.preventDefault();
    e.stopPropagation();
  }


  /**
   * Handle drop image file event
   */
  dropImage = async (e) => {
    e.preventDefault();
    const dt = e.dataTransfer;
    const { files } = dt;
    await this.saveFile(files[0]);
  }

  /**
   * Enter and space buttons press handler
   * Triggers file input
   */
  keyboardAccess = (e) => {
    if (e.which === 32 || e.which === 13) {
      e.preventDefault();
      e.target.click();
    }
  }

  render() {
    const {
      type,
      isValid,
    } = this.props;

    const {
      value,
      mode,
      file,
    } = this.state;

    const fileText = (type === 'front') ? 'Front' : 'Side';

    const classes = classNames('upload-file',
      {
        'upload-file--invalid': !isValid,
      });

    return (
      <label
        onDragOver={this.disableDragEvents}
        onDragLeave={this.disableDragEvents}
        onDrop={this.dropImage}
        className={classes}
        htmlFor={type}
        tabIndex="0"
        onKeyPress={this.keyboardAccess}
        onKeyUp={this.keyboardAccess}
      >
        <input type="file" name={type} id={type} onChange={this.onChange} tabIndex="-1" value={value} accept="image/*" />
        <div className={`upload-file__image upload-file__image--placeholder ${mode === 'placeholder' ? 'active' : ''}`}>
          {(type === 'front') ? (
            <svg width="112px" height="375px" viewBox="0 0 112 375" version="1.1" xmlns="http://www.w3.org/2000/svg">
              <g stroke="none" strokeWidth="1" fill="none" fillRule="evenodd">
                <g transform="translate(-132.000000, -121.000000)" stroke="#000000" strokeWidth="2">
                  <path d="M241.999904,316.408022 C242.122265,314.178623 241.231644,312.49602 241.263738,307.048165 C241.293827,301.60232 239.305977,281.813136 238.672112,272.009007 C238.038247,262.204878 235.61311,257.651597 235.236,250.571395 C234.860897,243.491193 230.542188,226.30331 231.133929,210.408037 C231.352573,204.544054 228.752923,200.722514 226.183361,198.543372 C222.031143,195.023374 217.253082,194.944973 212.878209,193.84133 C208.944633,192.850263 206.361031,190.763593 203.943918,190.118294 C202.746394,189.798659 200.674296,188.948312 199.891994,188.051727 C199.019427,187.052619 197.629336,185.645424 196.68255,178.76826 C198.251166,177.32287 199.647274,175.616143 200.766568,173.913437 C202.32716,171.541308 203.440436,169.424485 204.274892,167.197096 C204.680084,166.115566 205.452357,165.237074 206.405161,164.587754 C206.409172,164.583734 206.41519,164.579713 206.419202,164.577703 C208.401034,163.212724 208.449175,162.762421 208.76009,160.539053 C208.908527,159.477626 210.663692,154.656978 209.169294,153.273906 C208.154308,152.335106 207.041032,153.197515 206.866518,152.592421 C206.99289,149.440304 206.774247,146.30427 205.83749,143.341119 C203.9038,137.233892 201.68126,132.041342 195.083845,129.982817 C195.113934,129.031955 195.013639,128.075062 194.756883,127.178478 C194.165142,125.109901 192.80514,123.393123 191.138235,122.609114 C190.139295,122.138709 189.076167,122 188.001003,122 C186.925839,122 185.862711,122.138709 184.863771,122.609114 C183.19486,123.393123 181.836864,125.109901 181.245123,127.178478 C180.988367,128.075062 180.886066,129.031955 180.91816,129.982817 C174.320746,132.041342 172.0962,137.233892 170.16251,143.341119 C169.225753,146.30427 169.00711,149.440304 169.135488,152.592421 C168.960974,153.197515 167.845692,152.335106 166.830706,153.273906 C165.336308,154.656978 167.091473,159.477626 167.23991,160.539053 C167.550825,162.762421 167.598966,163.212724 169.580798,164.577703 C169.586816,164.579713 169.590828,164.583734 169.596845,164.587754 C170.549649,165.237074 171.319916,166.115566 171.725108,167.197096 C172.56157,169.424485 173.67284,171.541308 175.233432,173.913437 C176.352726,175.616143 177.748834,177.32287 179.319456,178.76826 C178.370664,185.645424 176.980573,187.052619 176.110012,188.051727 C175.32771,188.948312 173.253606,189.798659 172.058088,190.118294 C169.640975,190.763593 167.057373,192.850263 163.121791,193.84133 C158.746918,194.944973 153.968857,195.023374 149.818644,198.543372 C147.249083,200.722514 144.649433,204.544054 144.868077,210.408037 C145.457812,226.30331 141.141109,243.491193 140.764,250.571395 C140.38689,257.651597 137.961753,262.204878 137.327888,272.009007 C136.696029,281.813136 134.706173,301.60232 134.738268,307.048165 C134.768356,312.49602 133.877735,314.178623 134.002101,316.408022 C134.126467,318.635411 133.683163,318.392167 133.205758,322.567516 C132.728353,326.742865 133.089416,332.251029 134.208709,337.097811 C134.912781,340.145393 136.126352,342.129538 138.262639,344.198115 C138.61969,344.543883 140.394913,345.864636 142.202232,346.696892 C142.944416,347.036629 143.303472,346.61246 143.957397,346.68684 C144.70961,346.771272 145.728609,347.299975 146.097695,346.749159 C146.910086,345.53294 142.262409,341.70738 141.506184,340.173537 C140.751964,338.639695 140.822171,336.715858 141.151139,333.646162 C141.480107,330.578477 142.485064,328.019392 143.078811,329.470813 C143.423827,330.31312 143.349608,331.893199 143.03067,334.305534 C142.799991,336.048445 142.543235,338.020529 143.207189,339.007576 C144.25427,340.569562 145.554095,338.991493 145.744656,337.879809 C146.468787,333.650183 146.420645,333.081274 147.090617,330.908163 C148.294158,327.008222 148.205899,324.205894 146.559053,321.481966 C144.914212,318.760049 143.873149,317.125692 143.780877,313.856979 C143.690612,310.590276 143.225242,311.042589 143.804948,306.412917 C144.38666,301.783245 148.671268,291.43433 153.140419,277.183464 C157.611577,262.930588 156.127209,262.190806 156.371929,253.295323 C156.554466,246.693567 158.036828,236.583876 158.805089,228.580956 C158.927449,232.43265 160.022156,237.443867 161.286275,242.797647 C163.121791,250.571395 163.599081,262.58482 163.613123,268.722201 C163.627164,275.651632 160.30751,285.180353 158.353761,288.881276 C154.672929,295.858954 151.282953,304.477018 150.550799,312.906117 C149.275045,327.583162 151.329089,334.263318 154.510451,346.871786 C158.181253,361.418163 160.945387,376.921432 161.49701,384.765539 C161.940315,391.071784 158.279542,397.424264 158.279542,412.505375 C158.279542,430.619997 161.458898,430.843138 166.943036,471.911121 C168.034247,480.076873 165.847813,482.79276 164.610171,484.877419 C163.372529,486.962078 159.727804,490.626816 159.64155,491.802829 C159.55329,492.976832 158.032816,494.786082 163.68545,494.786082 C169.530651,494.786082 172.533487,495.216282 173.718976,494.377996 C173.989772,494.187019 174.374906,494.235266 174.611602,494.470469 C175.006765,494.862473 175.678742,495.196179 177.104939,494.864483 C178.466947,494.546859 179.148954,493.577905 179.094795,491.887261 C179.0627,490.853977 179.134913,490.256925 179.337509,488.41752 C179.574206,486.25848 178.659514,485.432256 179.16099,482.738482 C179.879103,478.890809 173.67284,475.87137 181.136804,439.573778 C185.276987,419.444857 181.560049,414.083444 180.276272,406.158925 C178.553201,395.502438 179.259279,390.921013 181.590138,378.658313 C182.603119,373.337105 188.001003,344.198115 186.318166,328.527993 C186.318166,328.527993 186.709202,327.472596 188.001003,327.472596 C189.292804,327.472596 189.681834,328.527993 189.681834,328.527993 C188.001003,344.198115 193.398887,373.337105 194.409862,378.658313 C196.742727,390.921013 197.448805,395.502438 195.723728,406.158925 C194.441957,414.083444 190.725019,419.444857 194.865202,439.573778 C202.329166,475.87137 196.120897,478.890809 196.83901,482.738482 C197.340486,485.432256 196.425794,486.25848 196.664497,488.41752 C196.865087,490.256925 196.939306,490.853977 196.905205,491.887261 C196.851046,493.577905 197.535059,494.546859 198.895061,494.864483 C200.321258,495.196179 200.993235,494.862473 201.388398,494.470469 C201.625094,494.235266 202.010228,494.187019 202.28303,494.377996 C203.466513,495.216282 206.469349,494.786082 212.31455,494.786082 C217.967184,494.786082 216.44671,492.976832 216.360456,491.802829 C216.272196,490.626816 212.627471,486.962078 211.389829,484.877419 C210.154193,482.79276 207.967759,480.076873 209.056964,471.911121 C214.541102,430.843138 217.722464,430.619997 217.722464,412.505375 C217.722464,397.424264 214.059685,391.071784 214.50299,384.765539 C215.056619,376.921432 217.820753,361.418163 221.491555,346.871786 C224.672917,334.263318 226.726961,327.583162 225.449201,312.906117 C224.717047,304.477018 221.327071,295.858954 217.646239,288.881276 C215.694496,285.180353 212.372836,275.651632 212.386877,268.722201 C212.400919,262.58482 212.878209,250.571395 214.71573,242.797647 C215.979819,237.449846 217.072551,232.43265 217.194911,228.580956 C217.963172,236.583876 219.445534,246.693567 219.628071,253.295323 C219.874797,262.190806 218.390429,262.930588 222.859581,277.183464 C227.328732,291.43433 231.61334,301.783245 232.195052,306.412917 C232.774758,311.042589 232.311394,310.590276 232.219123,313.856979 C232.128857,317.125692 231.085788,318.760049 229.440947,321.481966 C227.794101,324.205894 227.705842,327.008222 228.909383,330.908163 C229.581361,333.081274 229.531213,333.650183 230.255344,337.879809 C230.445905,338.991493 231.74573,340.569562 232.794817,339.007576 C233.456765,338.020529 233.200009,336.048445 232.96933,334.305534 C232.652398,331.893199 232.578179,330.31312 232.923195,329.470813 C233.516942,328.019392 234.519893,330.578477 234.848861,333.646162 C235.177829,336.715858 235.250042,338.639695 234.493816,340.173537 C233.737591,341.70738 229.09192,345.53294 229.904311,346.749159 C230.271391,347.299975 231.29039,346.771272 232.042603,346.68684 C232.698533,346.61246 233.05759,347.036629 233.797768,346.696892 C235.605087,345.864636 237.38031,344.543883 237.737361,344.198115 C239.873648,342.129538 241.087219,340.145393 241.791291,337.097811 C242.910584,332.251029 243.271647,326.742865 242.794242,322.567516 C242.316837,318.392167 241.875538,318.635411 241.999904,316.408022 Z" />
                </g>
              </g>
            </svg>
          ) : null}

          {(type === 'side') ? (
            <svg width="62px" height="375px" viewBox="0 0 62 375" version="1.1" xmlns="http://www.w3.org/2000/svg">
              <g stroke="none" strokeWidth="1" fill="none" fillRule="evenodd">
                <g transform="translate(-162.000000, -121.000000)" stroke="#000000" strokeWidth="2">
                  <path d="M210.528507,253.852219 C213.297877,235.121007 222.072915,227.202757 217.979239,208.06548 C217.532437,205.970833 216.954814,203.904329 216.377191,201.841845 C215.809631,199.811525 215.234021,197.763112 214.235759,195.905671 C213.225423,194.030137 211.810548,192.409901 210.611025,190.64895 C207.018492,185.380168 202.965068,177.496093 205.134676,170.987006 C206.118849,168.040027 208.157637,168.120435 211.95747,163.919079 C220.136771,154.877118 221.827375,145.250183 216.854183,137.372138 C216.64487,137.042462 216.415431,136.710776 216.173916,136.37909 C219.245179,135.492584 221.521456,132.678279 221.565734,129.335286 C221.618062,125.284696 218.371701,122 214.314252,122 C210.272904,122 206.954088,125.260574 206.877608,129.293071 C202.657137,127.62459 197.361925,127.019515 191.020148,128.555321 C187.286732,129.457909 182.315552,131.102268 179.986947,133.062231 C178.753209,134.101513 179.481778,135.08451 178.805537,136.385121 C176.559449,140.70106 175.062057,146.060301 175.005704,147.453382 C174.909098,149.849562 176.189126,151.783392 174.776265,154.264001 C173.280886,156.891357 172.103501,157.795955 170.306228,160.708761 C168.510968,163.621567 172.506026,163.46075 172.733452,164.053764 C173.578754,166.242891 172.246397,167.260062 172.268536,168.233007 C172.310801,170.178899 174.102036,169.73062 174.102036,169.73062 C173.148052,170.056275 172.139728,171.312662 173.407681,172.181076 C174.597141,172.995214 175.512885,172.500701 174.17449,176.354289 C172.373192,181.544672 184.805167,178.378579 186.087208,179.208799 C188.522483,180.78883 188.580849,180.623992 190.132581,186.548105 C190.655864,188.548272 190.937631,189.776515 190.786684,191.099239 C190.106417,197.103761 188.657328,197.736979 185.197629,200.96539 C181.637298,204.290291 177.95621,211.9246 175.126187,216.639061 C171.245866,223.103187 165.82732,233.341963 166.300286,236.009523 C167.678933,243.799118 173.524413,245.093699 177.762998,243.861435 C177.702619,245.091689 177.636203,249.876008 177.95621,254.951809 C178.278229,260.025599 182.44436,264.345558 179.890341,281.649516 C176.740585,302.996023 177.461104,305.305763 177.726771,314.556787 C177.80325,317.194194 177.547647,316.394127 176.607752,321.186487 C174.011468,334.431814 174.42003,346.448898 177.155186,360.832009 C179.644801,373.932601 182.414171,381.872963 185.024543,389.083615 C185.618267,390.723953 185.569964,391.52603 185.105048,392.985449 C182.657698,400.64639 184.249683,405.376434 187.86033,409.702423 C189.208787,411.316628 188.780098,418.364453 189.184636,421.828059 C192.535654,450.546036 191.481039,465.906113 190.319755,474.793287 C189.975597,477.422652 187.290757,480.894299 184.89171,483.013069 C181.667487,485.857528 175.26332,486.818412 172.314826,487.751153 C171.040836,488.153197 169.929868,488.866824 168.929594,488.864814 C167.587174,488.858784 166.629165,488.991458 166.170287,489.108051 C164.556163,489.514115 163.153365,490.225732 163.006443,492.05503 C162.861534,493.884329 165.178064,494.825111 168.229201,494.927632 C171.28235,495.028143 183.309788,494.774856 186.745336,493.910462 C197.675894,491.160483 198.090494,495 202.977144,495 C204.82272,495 208.53601,493.8984 209.153885,492.380686 C210.174285,489.877964 207.509572,485.159982 207.076858,483.519644 C204.353778,473.229337 203.623196,472.260412 206.006142,462.488742 C209.868367,446.648223 212.349931,444.197767 213.283789,424.061411 C213.879525,411.208076 211.061852,408.120381 209.010989,402.907886 C208.501795,401.613305 208.600414,399.140737 208.250217,397.401898 C207.942286,395.878153 207.161388,395.160505 207.066795,393.031684 C206.984277,391.113936 208.254243,389.045421 208.890232,386.769854 C214.392744,367.027502 213.380395,351.122656 212.575345,338.146697 C212.343893,334.411712 215.616419,331.691887 216.419456,330.513899 C220.825089,324.045017 224.145917,315.996104 222.563995,308.393458 C220.227339,297.178451 211.291291,287.625895 209.910632,276.24806 C209.413514,272.145205 209.92472,257.941003 210.528507,253.852219 Z" />
                </g>
              </g>
            </svg>
          ) : null}
        </div>
        <div className={`upload-file__image upload-file__image--preview ${mode === 'preview' ? 'active' : ''}`}>
          <img src={file} alt={`${fileText} preview`} />
        </div>
      </label>
    );
  }
}
